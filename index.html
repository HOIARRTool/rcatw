<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3E%E2%9C%A8%3C/text%3E%3C/svg%3E">
    <title>RCA Insight Companion</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #F8FAFC;
            color: #334155;
        }
        
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 100%;
            height: 300px;
        }

        @media (min-width: 768px) {
            .chart-container {
                height: 500px; 
            }
        }

        .rca-table, .action-table, .initiative-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
            margin-top: 10px;
            margin-bottom: 20px;
        }
        .rca-table th, .action-table th, .initiative-table th {
            color: white;
            padding: 10px;
            text-align: left;
            border: 1px solid #e2e8f0;
        }
        .rca-table th { background-color: #F59E0B; }
        .action-table th { background-color: #0EA5E9; }
        .initiative-table th { background-color: #7C3AED; }
        .rca-table td, .action-table td, .initiative-table td {
            border: 1px solid #e2e8f0;
            padding: 10px;
            vertical-align: top;
        }
        tr:nth-child(even) { background-color: #f8fafc; }

        .fishbone-grid {
            display: grid;
            grid-template-columns: repeat(1, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        @media (min-width: 768px) {
            .fishbone-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        .fishbone-card {
            background-color: #fff;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            padding: 1rem;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .fishbone-header {
            font-weight: bold;
            color: #475569;
            border-bottom: 2px solid #cbd5e1;
            padding-bottom: 0.5rem;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .why-step {
            display: flex;
            align-items: flex-start;
            margin-bottom: 0.5rem;
            position: relative;
        }
        .why-number {
            background-color: #EC4899; 
            color: white;
            font-weight: bold;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.75rem;
            margin-right: 0.75rem;
            flex-shrink: 0;
            z-index: 10;
        }
        .why-line {
            position: absolute;
            left: 11px;
            top: 24px;
            bottom: -10px;
            width: 2px;
            background-color: #FBCFE8; 
            z-index: 0;
        }
        .why-step:last-child .why-line {
            display: none;
        }

        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #0EA5E9;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        html { scroll-behavior: smooth; }
    </style>
</head>
<body class="bg-slate-50">
    <header class="relative w-full h-64 bg-gradient-to-r from-slate-800 to-slate-900 shadow-xl overflow-hidden mb-8 flex items-center justify-center">
      <div class="absolute top-0 left-0 w-full h-full opacity-10 pointer-events-none">
        <div class="absolute top-10 left-10 w-64 h-64 bg-teal-500 rounded-full filter blur-3xl"></div>
        <div class="absolute bottom-10 right-10 w-64 h-64 bg-blue-500 rounded-full filter blur-3xl"></div>
      </div>
    
      <div class="relative z-10 text-center px-4 md:px-20 mt-4">
        <h1 class="text-white font-bold text-xs md:text-sm lg:text-base leading-relaxed tracking-wide shadow-black drop-shadow-md">
          Bridging the Quality Gap: Evaluation of an AI-Assisted RCA Toolkit Across Six Asian Healthcare Systems<br>
          <span class="text-slate-300 font-medium">‚Äì A Collaborative Initiative between Thailand, Taiwan, Myanmar, Malaysia, Brunei, and the Philippines. ‚Äì</span>
        </h1>
      </div>
    
      <div class="absolute top-6 right-6 flex items-center gap-4 z-20">           
        <div class="flex gap-2">
        <a href="https://rca-th.onrender.com/" target="_blank" rel="noopener noreferrer" title="Open Thailand Tool">
          <img src="https://flagcdn.com/h40/th.png" alt="Thailand" class="h-6 rounded shadow-lg opacity-90 hover:opacity-100 hover:scale-110 transition-transform duration-200">
        </a>    
          <img src="https://flagcdn.com/h40/tw.png" alt="Taiwan" title="Taiwan" class="h-6 rounded shadow-lg opacity-90 hover:opacity-100 hover:scale-110 transition-transform duration-200">
          <img src="https://flagcdn.com/h40/mm.png" alt="Myanmar" title="Myanmar" class="h-6 rounded shadow-lg opacity-90 hover:opacity-100 hover:scale-110 transition-transform duration-200">
          <img src="https://flagcdn.com/h40/ph.png" alt="Philippines" title="Philippines" class="h-6 rounded shadow-lg opacity-90 hover:opacity-100 hover:scale-110 transition-transform duration-200">
          <img src="https://flagcdn.com/h40/my.png" alt="Malaysia" title="Malaysia" class="h-6 rounded shadow-lg opacity-90 hover:opacity-100 hover:scale-110 transition-transform duration-200">
          <img src="https://flagcdn.com/h40/bn.png" alt="Brunei" title="Brunei" class="h-6 rounded shadow-lg opacity-90 hover:opacity-100 hover:scale-110 transition-transform duration-200">
        </div>
      </div>
    </header>


    <main class="container mx-auto px-4 -mt-20 pb-16 space-y-24 max-w-screen-2xl relative z-20">

        <section id="ai-lab">
            <div class="bg-gradient-to-r from-indigo-600 to-blue-600 rounded-3xl p-1 shadow-2xl transform hover:scale-[1.01] transition-transform duration-300">
                <div class="bg-white rounded-[20px] p-6 md:p-10">
                    <div class="text-center mb-10">
                        <span class="bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wide">Interactive Support</span>
                        <h2 class="text-3xl md:text-4xl font-extrabold text-slate-800 mt-4 mb-2 flex items-center justify-center gap-3">
                            <span>‚ú®</span> RCA Insight Companion
                        </h2>
                        <p class="text-slate-500 max-w-2xl mx-auto">
                            Your supportive partner for deep learning, root cause analysis, and creating safer systems together.
                        </p>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 items-start">
                        <div class="space-y-6 lg:col-span-1">
                            <div class="bg-slate-50 rounded-2xl p-6 border border-slate-200 shadow-sm hover:shadow-md transition duration-300">
                                <h3 class="text-lg font-bold text-slate-800 mb-3 flex items-center gap-2">
                                    <span class="text-2xl">üè•</span> 1. Hospital Risk or Incident Report
                                </h3>
                                <p class="text-xs text-slate-500 mb-3">Describe the incident. We will help you visualize the root causes.</p>
                                <textarea id="scenarioInput" class="w-full p-4 border border-slate-300 rounded-xl text-sm focus:ring-2 focus:ring-amber-500 outline-none transition shadow-inner mb-4 bg-white" rows="6" placeholder="Example: Nurse administered wrong medication due to similar packaging and high workload..."></textarea>
                                
                                <button id="combinedRunButton" onclick="startFullAnalysis()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-xl transition shadow-lg hover:shadow-green-500/30 flex justify-center items-center gap-2 transform active:scale-95">
                                    <span id="runSpinner" class="loader hidden border-white border-t-green-800"></span>
                                    <span>üîç Root Cause Analysis</span>
                                </button>
                                
                                <div id="analyzeResult" class="mt-4 p-4 bg-white rounded-xl text-sm text-slate-700 hidden border border-amber-100 shadow-inner"></div>
                            </div>
                        </div>
                        <div class="bg-blue-50 rounded-2xl p-6 border-2 border-blue-100 shadow-md relative overflow-hidden h-full lg:col-span-2">
                            <div class="absolute top-0 right-0 bg-blue-200 text-blue-800 text-[10px] font-bold px-2 py-1 rounded-bl-lg">STEP 2 (Automatic)</div>
                            <h3 class="text-lg font-bold text-blue-900 mb-3 flex items-center gap-2">
                                <span class="text-2xl">üéØ</span> 2. Risk Analysis & Action Plan
                            </h3>
                            <p class="text-xs text-blue-700 mb-4">The system generates 3 key parts: PDSA, Action Plan, Initiative Ideas, and Conclusion & Recommendations.</p>
                            <label class="block text-xs font-bold text-slate-500 mb-1 uppercase">Input Data:</label>
                            <textarea id="planInput" class="w-full p-4 border border-blue-200 rounded-xl text-sm focus:ring-2 focus:ring-blue-500 outline-none h-24 bg-white mb-4 shadow-inner font-mono text-slate-600" placeholder="Waiting for analysis results..."></textarea>
                            <div class="flex gap-2">
                                <button onclick="exportToWord()" class="w-full bg-white hover:bg-slate-50 text-blue-700 border border-blue-200 font-bold py-3 px-4 rounded-xl transition shadow-md flex justify-center items-center gap-2 transform active:scale-95" title="Export to Word">
                                    <span class="text-lg">üìÑ</span>
                                    <span class="md:inline">Export Word</span>
                                </button>
                            </div>
                            <div id="planResult" class="mt-6 p-5 bg-white rounded-xl text-sm text-slate-700 border border-blue-100 shadow-lg min-h-[100px] hidden overflow-x-auto"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="mt-20 flex items-center justify-center">
                <div class="h-px w-24 bg-slate-300"></div>
                <span class="px-4 text-slate-400 text-sm font-semibold tracking-wider uppercase">Deep Dive Knowledge</span>
                <div class="h-px w-24 bg-slate-300"></div>
            </div>
        </section>

        <section>
            <div class="text-center mb-12">
                <h2 class="text-3xl font-bold text-slate-800">1. Core Concepts in Depth</h2>
                <div class="h-1 w-20 bg-teal-500 mx-auto mt-4 rounded-full"></div>
                <p class="text-slate-600 mt-4 max-w-3xl mx-auto">
                    Understanding the 6 pillars of safety to visualize "how accidents happen" and "how to prevent them" without blaming individuals.
                </p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-12">

                <div class="bg-white p-8 rounded-2xl shadow-lg border-t-4 border-cyan-500 hover:shadow-xl transition group">
                    <div class="flex items-center gap-3 mb-4">
                        <span class="text-4xl">üêü</span>
                        <h3 class="font-bold text-2xl text-slate-800">1. Fishbone Diagram (Ishikawa)</h3>
                    </div>
                    <p class="text-slate-600 leading-relaxed mb-6">
                        <strong>Dr. Kaoru Ishikawa</strong> developed this tool for RCA. In healthcare, we focus on the <strong>6 Ms</strong>:
                    </p>
                    
                    <div class="w-full overflow-hidden bg-slate-50 rounded-xl border border-slate-200 p-2 mb-4 flex justify-center">
                        <svg viewBox="0 0 800 350" class="w-full h-auto drop-shadow-sm">
                            <line x1="50" y1="175" x2="650" y2="175" stroke="#334155" stroke-width="4" marker-end="url(#arrowhead)" />
                            <polygon points="650,140 780,175 650,210" fill="#0EA5E9" />
                            <text x="660" y="180" font-family="sans-serif" font-size="16" font-weight="bold" fill="white">PROBLEM</text>
                            <text x="670" y="200" font-family="sans-serif" font-size="12" fill="#E0F2FE">(Effect)</text>
                            <line x1="150" y1="50" x2="200" y2="175" stroke="#64748B" stroke-width="2" />
                            <rect x="100" y="20" width="100" height="30" rx="5" fill="white" stroke="#64748B" />
                            <text x="150" y="40" font-family="sans-serif" font-size="14" font-weight="bold" fill="#334155" text-anchor="middle">MAN</text>
                            <line x1="350" y1="50" x2="400" y2="175" stroke="#64748B" stroke-width="2" />
                            <rect x="300" y="20" width="100" height="30" rx="5" fill="white" stroke="#64748B" />
                            <text x="350" y="40" font-family="sans-serif" font-size="14" font-weight="bold" fill="#334155" text-anchor="middle">MACHINE</text>
                            <line x1="550" y1="50" x2="600" y2="175" stroke="#64748B" stroke-width="2" />
                            <rect x="500" y="20" width="100" height="30" rx="5" fill="white" stroke="#64748B" />
                            <text x="550" y="40" font-family="sans-serif" font-size="14" font-weight="bold" fill="#334155" text-anchor="middle">METHOD</text>
                            <line x1="150" y1="300" x2="200" y2="175" stroke="#64748B" stroke-width="2" />
                            <rect x="100" y="300" width="100" height="30" rx="5" fill="white" stroke="#64748B" />
                            <text x="150" y="320" font-family="sans-serif" font-size="14" font-weight="bold" fill="#334155" text-anchor="middle">MATERIAL</text>
                            <line x1="450" y1="300" x2="500" y2="175" stroke="#64748B" stroke-width="2" />
                            <rect x="400" y="300" width="120" height="30" rx="5" fill="white" stroke="#64748B" />
                            <text x="460" y="320" font-family="sans-serif" font-size="14" font-weight="bold" fill="#334155" text-anchor="middle">ENVIRONMENT</text>
                            <defs><marker id="arrowhead" markerWidth="10" markerHeight="7" refX="0" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill="#334155" /></marker></defs>
                        </svg>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 text-xs text-slate-600 bg-cyan-50 p-4 rounded-xl border border-cyan-100">
                        <div>
                            <strong class="text-cyan-800">1. Man (People):</strong>
                            <p>Staff competency, fatigue, stress, staffing levels, and training.</p>
                        </div>
                        <div>
                            <strong class="text-cyan-800">2. Machine (Equipment):</strong>
                            <p>Failure, calibration issues, lack of maintenance, or usability design.</p>
                        </div>
                        <div>
                            <strong class="text-cyan-800">3. Method (Process):</strong>
                            <p>Unclear SOPs, outdated guidelines, or poor communication protocols.</p>
                        </div>
                        <div>
                            <strong class="text-cyan-800">4. Material (Supplies):</strong>
                            <p>Defective drugs, look-alike packaging, or poor quality consumables.</p>
                        </div>
                        <div>
                            <strong class="text-cyan-800">5. Environment (Mother Nature):</strong>
                            <p>Noise, lighting, layout, distractions, or temperature.</p>
                        </div>
                        <div>
                            <strong class="text-cyan-800">6. Measurement:</strong>
                            <p>Data accuracy, interpretation of lab results, or indicator validity.</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-8 rounded-2xl shadow-lg border-t-4 border-pink-500 hover:shadow-xl transition group">
                    <div class="flex items-center gap-3 mb-4">
                        <span class="text-4xl">‚ùì</span>
                        <h3 class="font-bold text-2xl text-slate-800">2. 5 Whys Technique</h3>
                    </div>
                    <p class="text-slate-600 leading-relaxed mb-4">
                        Developed by <strong>Sakichi Toyoda</strong> (Toyota), this technique drills down into a specific problem identified in the Fishbone diagram to find the single root cause by asking "Why?" five times.
                    </p>
                    <div class="bg-pink-50 p-4 rounded-lg border border-pink-100">
                        <strong class="text-pink-800 block mb-2 text-sm">Example: Patient fell.</strong>
                        <div class="space-y-0">
                            <div class="why-step">
                                <div class="why-number">1</div><div class="why-line"></div>
                                <div class="text-sm text-slate-700 pt-1">Why? Floor was wet.</div>
                            </div>
                            <div class="why-step">
                                <div class="why-number">2</div><div class="why-line"></div>
                                <div class="text-sm text-slate-700 pt-1">Why? Pipe leaked.</div>
                            </div>
                            <div class="why-step">
                                <div class="why-number">3</div><div class="why-line"></div>
                                <div class="text-sm text-slate-700 pt-1">Why? Seal broke.</div>
                            </div>
                            <div class="why-step">
                                <div class="why-number">4</div><div class="why-line"></div>
                                <div class="text-sm text-slate-700 pt-1">Why? Bought cheap seal.</div>
                            </div>
                            <div class="why-step">
                                <div class="why-number">5</div>
                                <div class="text-sm text-slate-700 pt-1 font-bold text-pink-700">Root Cause: Procurement policy focuses on lowest price, not quality.</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-8 rounded-2xl shadow-lg border-t-4 border-green-600 hover:shadow-xl transition group">
                  <div class="flex items-center gap-3 mb-4">
                    <span class="text-4xl">üéÑ</span>
                    <h3 class="font-bold text-2xl text-slate-800">5. Christmas Tree Diagram (FTA)</h3>
                  </div>
                
                  <p class="text-xs text-slate-500 mb-3">Visual map of failure pathways</p>
                
                  <div class="bg-green-50 p-6 rounded-xl border border-green-200 flex flex-col items-center overflow-x-auto">
                    <div class="bg-red-500 text-white px-4 py-2 rounded-lg font-bold text-sm shadow-md z-10 text-center">...Identify Top Event (Accident)...</div>
                    <div class="h-6 w-0.5 bg-slate-400"></div>
                
                    <div class="bg-slate-800 text-white text-[10px] px-2 py-0.5 rounded z-10 relative">OR</div>
                    <div class="h-4 w-0.5 bg-slate-400"></div>
                
                    <div class="w-64 h-0.5 bg-slate-400"></div>
                
                    <div class="flex justify-between w-full max-w-md gap-4">
                      <div class="flex flex-col items-center w-1/2">
                        <div class="h-4 w-0.5 bg-slate-400"></div>
                        <div class="bg-white border-2 border-green-500 text-green-800 px-3 py-2 rounded-lg text-xs font-bold shadow-sm text-center">
                          ...Immediate Cause A...
                        </div>
                      </div>
                
                      <div class="flex flex-col items-center w-1/2">
                        <div class="h-4 w-0.5 bg-slate-400"></div>
                        <div class="bg-blue-600 text-white text-[10px] px-2 py-0.5 rounded z-10 relative">AND</div>
                        <div class="h-4 w-0.5 bg-slate-400"></div>
                
                        <div class="w-24 h-0.5 bg-slate-400"></div>
                
                        <div class="flex justify-between w-full gap-2">
                          <div class="flex flex-col items-center">
                            <div class="h-3 w-0.5 bg-slate-400"></div>
                            <div class="bg-white border border-green-500 text-green-700 px-2 py-1 rounded text-[10px] text-center">...Root Cause 1...</div>
                          </div>
                          <div class="flex flex-col items-center">
                            <div class="h-3 w-0.5 bg-slate-400"></div>
                            <div class="bg-white border border-green-500 text-green-700 px-2 py-1 rounded text-[10px] text-center">...Root Cause 2...</div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="bg-white p-8 rounded-2xl shadow-lg border-t-4 border-amber-500 hover:shadow-xl transition group">
                    <div class="flex items-center gap-3 mb-4">
                        <span class="text-4xl">üßÄ</span>
                        <h3 class="font-bold text-2xl text-slate-800">4. Swiss Cheese Model</h3>
                    </div>
                    <p class="text-slate-600 leading-relaxed mb-6">
                        <strong>James Reason's Model:</strong> Accidents happen when the "holes" (weaknesses) in multiple layers of defense align, allowing a hazard to pass through.
                    </p>

                    <div class="w-full overflow-hidden bg-slate-50 rounded-xl border border-slate-200 p-6 mb-6 flex justify-center">
                        <svg viewBox="0 0 800 320" class="w-full h-auto drop-shadow-sm">
                            <defs>
                                <marker id="arrowRed" markerWidth="10" markerHeight="7" refX="0" refY="3.5" orient="auto">
                                    <polygon points="0 0, 10 3.5, 0 7" fill="#EF4444" />
                                </marker>
                            </defs>

                            <line x1="50" y1="140" x2="720" y2="140" stroke="#EF4444" stroke-width="4" stroke-dasharray="10,5" marker-end="url(#arrowRed)" />
                            <text x="50" y="120" font-family="sans-serif" font-size="14" font-weight="bold" fill="#EF4444">HAZARD</text>

                            <g transform="translate(150, 40)">
                                <rect x="0" y="0" width="70" height="200" rx="4" fill="#FEF3C7" stroke="#334155" stroke-width="2" />
                                <circle cx="35" cy="40" r="10" fill="white" stroke="#334155" stroke-width="1" />
                                <circle cx="20" cy="180" r="8" fill="white" stroke="#334155" stroke-width="1" />
                                <circle cx="35" cy="100" r="15" fill="white" stroke="#EF4444" stroke-width="2" stroke-dasharray="4,2" />
                                <text x="35" y="230" font-family="sans-serif" font-size="12" font-weight="bold" fill="#334155" text-anchor="middle">Policy</text>
                            </g>

                            <g transform="translate(300, 40)">
                                <rect x="0" y="0" width="70" height="200" rx="4" fill="#FDE68A" stroke="#334155" stroke-width="2" />
                                <circle cx="20" cy="50" r="9" fill="white" stroke="#334155" stroke-width="1" />
                                <circle cx="50" cy="160" r="11" fill="white" stroke="#334155" stroke-width="1" />
                                <circle cx="35" cy="100" r="15" fill="white" stroke="#EF4444" stroke-width="2" stroke-dasharray="4,2" />
                                <text x="35" y="230" font-family="sans-serif" font-size="12" font-weight="bold" fill="#334155" text-anchor="middle">Supervision</text>
                            </g>

                            <g transform="translate(450, 40)">
                                <rect x="0" y="0" width="70" height="200" rx="4" fill="#FCD34D" stroke="#334155" stroke-width="2" />
                                <circle cx="45" cy="30" r="8" fill="white" stroke="#334155" stroke-width="1" />
                                <circle cx="25" cy="170" r="10" fill="white" stroke="#334155" stroke-width="1" />
                                <circle cx="35" cy="100" r="15" fill="white" stroke="#EF4444" stroke-width="2" stroke-dasharray="4,2" />
                                <text x="35" y="230" font-family="sans-serif" font-size="12" font-weight="bold" fill="#334155" text-anchor="middle">Conditions</text>
                            </g>

                            <g transform="translate(600, 40)">
                                <rect x="0" y="0" width="70" height="200" rx="4" fill="#F59E0B" stroke="#334155" stroke-width="2" />
                                <circle cx="20" cy="60" r="12" fill="white" stroke="#334155" stroke-width="1" />
                                <circle cx="50" cy="150" r="9" fill="white" stroke="#334155" stroke-width="1" />
                                <circle cx="35" cy="100" r="15" fill="white" stroke="#EF4444" stroke-width="2" stroke-dasharray="4,2" />
                                <text x="35" y="230" font-family="sans-serif" font-size="12" font-weight="bold" fill="#334155" text-anchor="middle">Action</text>
                            </g>

                            <g transform="translate(740, 140)">
                                <path d="M0 -20 L5 -5 L20 0 L5 5 L0 20 L-5 5 L-20 0 L-5 -5 Z" fill="#EF4444" stroke="#991B1B" stroke-width="2" />
                                <text x="0" y="40" font-family="sans-serif" font-size="14" font-weight="bold" fill="#EF4444" text-anchor="middle">LOSS</text>
                            </g>
                        </svg>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 text-xs text-slate-600 bg-amber-50 p-4 rounded-xl border border-amber-100">
                        <div>
                            <strong class="text-amber-800">1. Organizational Influences:</strong>
                            <p>Resource allocation, organizational culture, policies.</p>
                        </div>
                        <div>
                            <strong class="text-amber-800">2. Unsafe Supervision:</strong>
                            <p>Inadequate training, poor scheduling, failure to correct issues.</p>
                        </div>
                        <div>
                            <strong class="text-amber-800">3. Preconditions:</strong>
                            <p>Fatigue, stress, high workload, poor equipment design.</p>
                        </div>
                        <div>
                            <strong class="text-amber-800">4. Unsafe Acts:</strong>
                            <p>Slips, lapses, mistakes, or procedural violations by staff.</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-8 rounded-2xl shadow-lg border-t-4 border-teal-500 hover:shadow-xl transition group">
                    <div class="flex items-center gap-3 mb-4">
                        <span class="text-4xl">‚öñÔ∏è</span>
                        <h3 class="font-bold text-2xl text-slate-800">5. Just Culture</h3>
                    </div>
                    <p class="text-slate-600 leading-relaxed mb-4">
                        A fair culture distinguishes between 3 types of behaviors (Human Error, At-Risk, Reckless) to manage them appropriately.
                    </p>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-slate-600 border border-slate-200 rounded-lg">
                            <thead class="bg-slate-100 text-slate-700 font-bold">
                                <tr>
                                    <th class="p-2 border-b">Behavior</th>
                                    <th class="p-2 border-b">Management</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="border-b bg-green-50">
                                    <td class="p-2 font-bold text-green-700">Human Error</td>
                                    <td class="p-2">Console</td>
                                </tr>
                                <tr class="border-b bg-yellow-50">
                                    <td class="p-2 font-bold text-yellow-700">At-Risk</td>
                                    <td class="p-2">Coach</td>
                                </tr>
                                <tr class="bg-red-50">
                                    <td class="p-2 font-bold text-red-700">Reckless</td>
                                    <td class="p-2">Punish</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                 <div class="bg-white p-8 rounded-2xl shadow-lg border-t-4 border-blue-500 hover:shadow-xl transition group">
                    <div class="flex items-center gap-3 mb-4">
                        <span class="text-4xl">üìê</span> <h3 class="font-bold text-2xl text-slate-800">6. Human Factors Engineering</h3>
                    </div>
                    <p class="text-slate-600 leading-relaxed mb-4">
                        Instead of trying to change the human (who is fallible), <strong>HFE</strong> focuses on <strong>designing the system</strong>, devices, and workspace to fit human capabilities and limitations.
                    </p>
                    
                    <div class="bg-blue-50 p-5 rounded-xl border border-blue-100 text-sm">
                        <strong class="text-blue-800 block mb-3 text-base">Key Engineering Strategies:</strong>
                        <ul class="space-y-3">
                            <li class="flex items-start gap-3">
                                <div class="bg-white p-1 rounded border border-blue-200 shadow-sm text-lg">üîí</div>
                                <div>
                                    <strong class="text-slate-700">Forcing Functions</strong>
                                    <p class="text-slate-500 text-xs mt-0.5">Designing so errors are impossible (e.g., connectors that physically cannot fit into the wrong port).</p>
                                </div>
                            </li>
                            <li class="flex items-start gap-3">
                                <div class="bg-white p-1 rounded border border-blue-200 shadow-sm text-lg">üìè</div>
                                <div>
                                    <strong class="text-slate-700">Standardization</strong>
                                    <p class="text-slate-500 text-xs mt-0.5">Uniformity in equipment and layouts (e.g., all crash carts packed identically) to reduce cognitive load.</p>
                                </div>
                            </li>
                            <li class="flex items-start gap-3">
                                <div class="bg-white p-1 rounded border border-blue-200 shadow-sm text-lg">üîä</div>
                                <div>
                                    <strong class="text-slate-700">Usability & Alerts</strong>
                                    <p class="text-slate-500 text-xs mt-0.5">Designing intuitive displays and distinct alarms to prevent confusion under stress.</p>
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>
                <div class="bg-white p-8 rounded-2xl shadow-lg border-t-4 border-indigo-600 hover:shadow-xl transition group">
                    <div class="flex items-center gap-3 mb-4">
                        <span class="text-4xl">üß©</span> <h3 class="font-bold text-2xl text-slate-800">7. Contributing Factors</h3>
                    </div>
                    <p class="text-slate-600 leading-relaxed mb-6">
                        Identifying the underlying conditions that influenced the event. These are not "causes" in themselves, but they increase the likelihood of an error occurring.
                    </p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        
                        <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-100">
                            <strong class="text-indigo-800 flex items-center gap-2">
                                <i class="fas fa-user-injured"></i> Patient Factors
                            </strong>
                            <p class="text-xs text-slate-600 mt-2">Clinical condition, complexity, communication barriers, or social factors.</p>
                        </div>

                        <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-100">
                            <strong class="text-indigo-800 flex items-center gap-2">
                                <i class="fas fa-tasks"></i> Task & Technology
                            </strong>
                            <p class="text-xs text-slate-600 mt-2">Protocol design, availability of test results, or equipment usability.</p>
                        </div>

                        <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-100">
                            <strong class="text-indigo-800 flex items-center gap-2">
                                <i class="fas fa-user-nurse"></i> Individual Factors
                            </strong>
                            <p class="text-xs text-slate-600 mt-2">Knowledge, skills, fatigue, stress, or physical health.</p>
                        </div>

                        <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-100">
                            <strong class="text-indigo-800 flex items-center gap-2">
                                <i class="fas fa-users"></i> Team Factors
                            </strong>
                            <p class="text-xs text-slate-600 mt-2">Verbal communication, written records, supervision, or seeking help.</p>
                        </div>

                        <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-100">
                            <strong class="text-indigo-800 flex items-center gap-2">
                                <i class="fas fa-hospital"></i> Work Environment
                            </strong>
                            <p class="text-xs text-slate-600 mt-2">Staffing levels, workload, noise, lighting, or administrative support.</p>
                        </div>

                        <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-100">
                            <strong class="text-indigo-800 flex items-center gap-2">
                                <i class="fas fa-sitemap"></i> Org. & Management
                            </strong>
                            <p class="text-xs text-slate-600 mt-2">Safety culture, priorities, policies, or financial constraints.</p>
                        </div>

                    </div>
                </div>
                <div class="bg-white p-8 rounded-2xl shadow-lg border-t-4 border-rose-500 hover:shadow-xl transition group">
                    <div class="flex items-center gap-3 mb-4">
                        <span class="text-4xl">üîÆ</span> <h3 class="font-bold text-2xl text-slate-800">8. FMEA (Future Prevention)</h3>
                    </div>
                    <p class="text-slate-600 leading-relaxed mb-4">
                        <strong>Failure Mode and Effects Analysis:</strong> While RCA looks backward to solve past problems, FMEA looks <strong>forward</strong> to predict and prevent future failures <em>before</em> they happen.
                    </p>

                    <div class="bg-rose-50 border-l-4 border-rose-500 p-4 mb-6 rounded-r-lg">
                        <strong class="text-rose-700 text-sm uppercase tracking-wide">üöÄ When to use:</strong>
                        <p class="text-rose-800 text-sm mt-1">
                            Use FMEA <strong>after</strong> designing your new Action Plan (from Step 2) to "stress-test" your new solutions before rolling them out hospital-wide.
                        </p>
                    </div>

                    <div class="bg-white border border-rose-100 rounded-xl p-4 shadow-sm">
                        <div class="text-center mb-3">
                            <span class="text-xs font-bold text-slate-400 uppercase">The Risk Formula (RPN)</span>
                        </div>
                        <div class="flex flex-wrap justify-center items-center gap-2 md:gap-4 text-center">
                            
                            <div class="bg-rose-100 p-3 rounded-lg w-24">
                                <div class="text-2xl font-bold text-rose-600">S</div>
                                <div class="text-[10px] text-rose-800 font-bold mt-1">Severity</div>
                                <div class="text-[9px] text-rose-600">(How bad?)</div>
                            </div>

                            <div class="text-slate-300 text-xl">‚úñ</div>

                            <div class="bg-rose-100 p-3 rounded-lg w-24">
                                <div class="text-2xl font-bold text-rose-600">O</div>
                                <div class="text-[10px] text-rose-800 font-bold mt-1">Occurrence</div>
                                <div class="text-[9px] text-rose-600">(How often?)</div>
                            </div>

                            <div class="text-slate-300 text-xl">‚úñ</div>

                            <div class="bg-rose-100 p-3 rounded-lg w-24">
                                <div class="text-2xl font-bold text-rose-600">D</div>
                                <div class="text-[10px] text-rose-800 font-bold mt-1">Detection</div>
                                <div class="text-[9px] text-rose-600">(Can we catch it?)</div>
                            </div>

                            <div class="text-slate-400 text-xl">=</div>

                            <div class="bg-slate-800 p-3 rounded-lg w-28 shadow-md">
                                <div class="text-2xl font-bold text-white">RPN</div>
                                <div class="text-[10px] text-slate-300 mt-1">Risk Priority Number</div>
                            </div>
                        </div>
                    </div>
                </div>
        </section>

        <section class="bg-white rounded-3xl shadow-xl p-8 md:p-12 border border-slate-200">
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-12">
                <div class="lg:col-span-5 space-y-6">
                    <h2 class="text-3xl font-bold text-slate-800">2. Assessment & Status</h2>
                    <div class="h-1 w-20 bg-teal-500 rounded-full"></div>
                    <p class="text-slate-600 leading-relaxed font-light italic border-l-4 border-teal-500 pl-4 bg-teal-50/50 p-2 rounded-r-lg">
                        "Based on <strong>AHRQ HSOPSC 2.0</strong> (10 Measures). Input your actual <strong>'% Positive Response'</strong> for each area. The chart reveals the gap between your reality and the ideal 100%."
                    </p>
                    
                    <div class="bg-slate-100 p-4 rounded-xl border border-slate-200 max-h-[500px] overflow-y-auto">
                        <h4 class="text-xs font-bold text-slate-500 uppercase mb-3 tracking-wide flex items-center gap-2 sticky top-0 bg-slate-100 py-2 border-b">
                            <span>üéöÔ∏è</span> Input % Positive Response
                        </h4>
                        <div class="space-y-4 text-sm">
                            <div>
                                <div class="flex justify-between mb-1">
                                    <label class="text-slate-700 font-semibold text-xs">1. Teamwork</label>
                                    <span id="val-0" class="text-teal-600 font-bold text-xs">0.00%</span>
                                </div>
                                <input type="range" min="0" max="100" step="0.01" value="0" class="w-full h-2 bg-slate-300 rounded-lg appearance-none cursor-pointer accent-teal-500" oninput="updateChartData(0, this.value)">
                            </div>
                            <div>
                                <div class="flex justify-between mb-1">
                                    <label class="text-slate-700 font-semibold text-xs">2. Staffing and Work Pace</label>
                                    <span id="val-1" class="text-teal-600 font-bold text-xs">0.00%</span>
                                </div>
                                <input type="range" min="0" max="100" step="0.01" value="0" class="w-full h-2 bg-slate-300 rounded-lg appearance-none cursor-pointer accent-teal-500" oninput="updateChartData(1, this.value)">
                            </div>
                            <div>
                                <div class="flex justify-between mb-1">
                                    <label class="text-slate-700 font-semibold text-xs">3. Organizational Learning</label>
                                    <span id="val-2" class="text-teal-600 font-bold text-xs">0.00%</span>
                                </div>
                                <input type="range" min="0" max="100" step="0.01" value="0" class="w-full h-2 bg-slate-300 rounded-lg appearance-none cursor-pointer accent-teal-500" oninput="updateChartData(2, this.value)">
                            </div>
                            <div>
                                <div class="flex justify-between mb-1">
                                    <label class="text-slate-700 font-semibold text-xs">4. Response to Error</label>
                                    <span id="val-3" class="text-teal-600 font-bold text-xs">0.00%</span>
                                </div>
                                <input type="range" min="0" max="100" step="0.01" value="0" class="w-full h-2 bg-slate-300 rounded-lg appearance-none cursor-pointer accent-teal-500" oninput="updateChartData(3, this.value)">
                            </div>
                            <div>
                                <div class="flex justify-between mb-1">
                                    <label class="text-slate-700 font-semibold text-xs">5. Supervisor Support</label>
                                    <span id="val-4" class="text-teal-600 font-bold text-xs">0.00%</span>
                                </div>
                                <input type="range" min="0" max="100" step="0.01" value="0" class="w-full h-2 bg-slate-300 rounded-lg appearance-none cursor-pointer accent-teal-500" oninput="updateChartData(4, this.value)">
                            </div>
                            <div>
                                <div class="flex justify-between mb-1">
                                    <label class="text-slate-700 font-semibold text-xs">6. Communication About Error</label>
                                    <span id="val-5" class="text-teal-600 font-bold text-xs">0.00%</span>
                                </div>
                                <input type="range" min="0" max="100" step="0.01" value="0" class="w-full h-2 bg-slate-300 rounded-lg appearance-none cursor-pointer accent-teal-500" oninput="updateChartData(5, this.value)">
                            </div>
                            <div>
                                <div class="flex justify-between mb-1">
                                    <label class="text-slate-700 font-semibold text-xs">7. Communication Openness</label>
                                    <span id="val-6" class="text-teal-600 font-bold text-xs">0.00%</span>
                                </div>
                                <input type="range" min="0" max="100" step="0.01" value="0" class="w-full h-2 bg-slate-300 rounded-lg appearance-none cursor-pointer accent-teal-500" oninput="updateChartData(6, this.value)">
                            </div>
                            <div>
                                <div class="flex justify-between mb-1">
                                    <label class="text-slate-700 font-semibold text-xs">8. Reporting Safety Events</label>
                                    <span id="val-7" class="text-teal-600 font-bold text-xs">0.00%</span>
                                </div>
                                <input type="range" min="0" max="100" step="0.01" value="0" class="w-full h-2 bg-slate-300 rounded-lg appearance-none cursor-pointer accent-teal-500" oninput="updateChartData(7, this.value)">
                            </div>
                            <div>
                                <div class="flex justify-between mb-1">
                                    <label class="text-slate-700 font-semibold text-xs">9. Hospital Mgmt. Support</label>
                                    <span id="val-8" class="text-teal-600 font-bold text-xs">0.00%</span>
                                </div>
                                <input type="range" min="0" max="100" step="0.01" value="0" class="w-full h-2 bg-slate-300 rounded-lg appearance-none cursor-pointer accent-teal-500" oninput="updateChartData(8, this.value)">
                            </div>
                            <div>
                                <div class="flex justify-between mb-1">
                                    <label class="text-slate-700 font-semibold text-xs">10. Handoffs & Info Exchange</label>
                                    <span id="val-9" class="text-teal-600 font-bold text-xs">0.00%</span>
                                </div>
                                <input type="range" min="0" max="100" step="0.01" value="0" class="w-full h-2 bg-slate-300 rounded-lg appearance-none cursor-pointer accent-teal-500" oninput="updateChartData(9, this.value)">
                            </div>
                        </div>
                    </div>

                    <div class="chart-container mt-6">
                        <canvas id="assessmentChart"></canvas>
                    </div>
                    <p class="text-xs text-center text-slate-400 mt-2">Interactive: Compare your % Positive vs 100% Ideal</p>
                </div>

                <div class="lg:col-span-7 space-y-6">
                    <h3 class="xl font-bold text-slate-700 border-l-4 border-teal-500 pl-4">Gap Analysis & Solutions</h3>
                    <div class="space-y-4">
                        <div class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                            <div class="flex items-start gap-3">
                                <div class="bg-red-100 text-red-600 p-2 rounded-lg font-bold text-xl">‚ö†Ô∏è</div>
                                <div>
                                    <h4 class="font-bold text-slate-800">Non-punitive Response to Error</h4>
                                    <p class="text-sm text-slate-600 mt-1"><strong>Issue:</strong> Staff fear punishment when reporting errors, leading to under-reporting and hidden risks.</p>
                                    <div class="mt-3 bg-white p-3 rounded border border-slate-200 text-sm">
                                        <strong class="text-teal-600">‚úÖ Solution:</strong>
                                        <ul class="list-disc list-inside text-slate-500 mt-1">
                                            <li>Executive declaration of a "Blame-free" policy.</li>
                                            <li>Use the <strong>Substitution Test</strong> (Would another qualified person make the same mistake? If yes = System Problem).</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                            <div class="flex items-start gap-3">
                                <div class="bg-amber-100 text-amber-600 p-2 rounded-lg font-bold text-xl">‚ö°</div>
                                <div>
                                    <h4 class="font-bold text-slate-800">Staffing & Workload</h4>
                                    <p class="text-sm text-slate-600 mt-1"><strong>Issue:</strong> Excessive workload leads to fatigue and reliance on shortcuts to finish tasks.</p>
                                    <div class="mt-3 bg-white p-3 rounded border border-slate-200 text-sm">
                                        <strong class="text-teal-600">‚úÖ Solution:</strong>
                                        <ul class="list-disc list-inside text-slate-500 mt-1">
                                            <li>Optimize shift scheduling (Avoid double shifts).</li>
                                            <li>Utilize automation technology to reduce paperwork and return time to patient care.</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section class="py-8">
            <div class="text-center mb-12">
                <h2 class="text-3xl font-bold text-slate-800">3. Implementation Roadmap</h2>
                <div class="h-1 w-20 bg-blue-500 mx-auto mt-4 rounded-full"></div>
                <p class="text-slate-600 mt-4">A 3-Phase strategic plan to systematically transform organizational culture.</p>
            </div>

            <div class="relative max-w-5xl mx-auto pl-8 md:pl-0">
                <div class="timeline-line hidden md:block" style="left: 50%; transform: translateX(-50%);"></div>
                
                <div class="relative grid grid-cols-1 md:grid-cols-2 gap-8 mb-16">
                    <div class="md:text-right md:pr-12 order-1">
                        <div class="bg-white p-6 rounded-2xl shadow-lg border-t-4 border-teal-500 relative">
                            <h3 class="text-xl font-bold text-teal-700">Phase 1: Build Trust</h3>
                            <span class="text-xs font-bold text-slate-400 uppercase tracking-wide">Duration: Months 1-3</span>
                            <p class="text-sm text-slate-600 mt-3 leading-relaxed">
                                Focus on shifting the mindset of leaders and staff to encourage open dialogue about safety.
                            </p>
                            <div class="mt-4 pt-4 border-t border-slate-100 text-left">
                                <strong class="text-sm text-slate-700 block mb-2">üöÄ Key Activities:</strong>
                                <ul class="text-sm text-slate-600 space-y-2">
                                    <li>üîπ <strong>Executive Safety Walkrounds:</strong> Leaders visit units to "listen, not to command".</li>
                                    <li>üîπ <strong>Stop the Blame Campaign:</strong> Shift focus from finding "who" to finding "what" (system flaws).</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="absolute left-0 md:left-1/2 -translate-x-1/2 top-6 w-10 h-10 bg-teal-500 rounded-full border-4 border-white shadow-md z-10 flex items-center justify-center text-white font-bold">1</div>
                    <div class="hidden md:block order-2"></div>
                </div>

                <div class="relative grid grid-cols-1 md:grid-cols-2 gap-8 mb-16">
                    <div class="hidden md:block order-1"></div>
                    <div class="absolute left-0 md:left-1/2 -translate-x-1/2 top-6 w-10 h-10 bg-blue-500 rounded-full border-4 border-white shadow-md z-10 flex items-center justify-center text-white font-bold">2</div>
                    <div class="md:pl-12 order-2">
                        <div class="bg-white p-6 rounded-2xl shadow-lg border-t-4 border-blue-500 relative">
                            <h3 class="text-xl font-bold text-blue-700">Phase 2: Reporting System</h3>
                            <span class="text-xs font-bold text-slate-400 uppercase tracking-wide">Duration: Months 4-6</span>
                            <p class="text-sm text-slate-600 mt-3 leading-relaxed">
                                Make reporting "easy" and "meaningful" for the reporter (avoid the "black hole" effect).
                            </p>
                            <div class="mt-4 pt-4 border-t border-slate-100 text-left">
                                <strong class="text-sm text-slate-700 block mb-2">üöÄ Key Activities:</strong>
                                <ul class="text-sm text-slate-600 space-y-2">
                                    <li>üîπ <strong>Simplify IR Form:</strong> Reduce form filling time to under 2 minutes.</li>
                                    <li>üîπ <strong>Good Catch Award:</strong> Reward staff for reporting near-misses.</li>
                                    <li>üîπ <strong>Feedback Loop:</strong> Provide feedback on actions taken within 7 days.</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="relative grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="md:text-right md:pr-12 order-1">
                        <div class="bg-white p-6 rounded-2xl shadow-lg border-t-4 border-amber-500 relative">
                            <h3 class="text-xl font-bold text-amber-600">Phase 3: Sustain & Learn</h3>
                            <span class="text-xs font-bold text-slate-400 uppercase tracking-wide">Duration: Month 7 onwards</span>
                            <p class="text-sm text-slate-600 mt-3 leading-relaxed">
                                Move from reactive problem solving to proactive learning (Proactive Learning).
                            </p>
                            <div class="mt-4 pt-4 border-t border-slate-100 text-left">
                                <strong class="text-sm text-slate-700 block mb-2">üöÄ Key Activities:</strong>
                                <ul class="text-sm text-slate-600 space-y-2">
                                    <li>üîπ <strong>Safety Huddles:</strong> Short 5-10 min briefings every morning to assess risks.</li>
                                    <li>üîπ <strong>RCA (Root Cause Analysis):</strong> Analyze system causes without blaming individuals.</li>
                                    <li>üîπ <strong>Sharing Success:</strong> Share "Safety-II" success stories across departments.</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="absolute left-0 md:left-1/2 -translate-x-1/2 top-6 w-10 h-10 bg-amber-500 rounded-full border-4 border-white shadow-md z-10 flex items-center justify-center text-white font-bold">3</div>
                    <div class="hidden md:block order-2"></div>
                </div>
            </div>
        </section>

    </main>
    <!-- Disclaimer box (place this above </footer> or inside footer, whichever you prefer) -->
    <div class="container mx-auto px-4 pb-6">
      <div class="bg-slate-50 border border-slate-200 rounded-2xl p-5 shadow-sm">
        <p class="text-indigo-700 font-bold italic mb-1">
          Disclaimer:
        </p>
        <p class="text-slate-600 text-sm leading-relaxed">
          The diagrams and content in this document were generated with AI assistance (AI-Assisted) as an initial guide for
          analysis and quality improvement in public health services. Users should review and validate the information, adapt
          it to their organizational context, and refer to relevant professional standards before applying it in practice.
        </p>
      </div>
    </div>

    <footer class="bg-slate-900 py-12 border-t border-slate-800 mt-12">
        <div class="container mx-auto px-4 text-center">
            <p class="text-slate-100 text-sm mb-2">This project is an initiative under the ASQua framework to harmonize quality standards across ASEAN member countries.</p>
            <p class="text-slate-200 text-sm mb-2"">The tool was developed by Krittichat Kamjornpreecha and Wilasinee Kueankaew.</p>
        </div>
    </footer>

    <script>
        // --- Core Gemini API Call Function (PROXY VERSION) ---
        async function callGemini(prompt) {
            try {
                // Call the proxy server endpoint
                const response = await fetch('/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: prompt })
                });

                if (!response.ok) {
                    const errData = await response.json();
                    throw new Error(`Server Error: ${errData.error?.message || response.statusText}`);
                }

                const data = await response.json();
                return data.candidates[0].content.parts[0].text;
            } catch (error) { 
                console.error(error);
                throw error; 
            }
        }
        function sanitizeLLMHtml(text) {
          return String(text ?? "")
            .replace(/```(?:html)?/gi, "")
            .replace(/```/g, "")
            .trim();
        }
        
        function stripHtml(html) {
          const tmp = document.createElement("div");
          tmp.innerHTML = html;
          return (tmp.textContent || tmp.innerText || "").trim();
        }
        
        function looksLikeRiskAnalysis(html) {
          // ‡πÄ‡∏ä‡πá‡∏Ñ signature ‡∏ó‡∏µ‡πà ‚Äú‡∏Ñ‡∏ß‡∏£‡∏°‡∏µ‚Äù ‡∏ï‡∏≤‡∏° prompt
          return (
            html.includes("1. Event Summary") &&
            html.includes("Fishbone Diagram") &&
            html.includes("5 Whys") &&
            html.includes("Swiss Cheese") &&
            html.length > 300
          );
        }

        // --- 1. Combined Workflow Starter ---
        async function startFullAnalysis() {
            const input = document.getElementById('scenarioInput').value;
            const runButton = document.getElementById('combinedRunButton');
            const spinner = document.getElementById('runSpinner');
            const resultDiv = document.getElementById('analyzeResult');
            const planInput = document.getElementById('planInput');
            const planResultDiv = document.getElementById('planResult');
            
            if (!input.trim()) { alert("Please enter a scenario."); return; }

            // 1. Start UI feedback
            runButton.disabled = true;
            spinner.classList.remove('hidden');
            resultDiv.classList.add('hidden');
            planResultDiv.classList.add('hidden');
            planResultDiv.innerHTML = '';
            planInput.value = 'Analyzing and generating plan... Please wait.';
            planInput.classList.remove('ring-4', 'ring-green-300', 'bg-green-50');

            try {
                // --- STEP 1: Analyze Risk ---
                const analysisData = await analyzeRiskStep(input);
                
                // Display analysis result
                resultDiv.innerHTML = analysisData.html;
                resultDiv.classList.remove('hidden');
                
                // Prepare data for Step 2
                const autoFilledContent = `[Scenario]\n${input}\n\n[Risk Analysis Results]\n${analysisData.cleanText}`;
                planInput.value = autoFilledContent;
                
                // --- STEP 2: Generate Action Plan (Automatic) ---
                planInput.value = 'Analysis complete... Generating detailed Action Plan...';
                const actionPlanHTML = await generateActionPlanStep(autoFilledContent);

                // Display action plan result
                planResultDiv.innerHTML = actionPlanHTML;
                planResultDiv.classList.remove('hidden');

                // Success Feedback
                planInput.value = '‚úî Action Plan Generated Successfully';
                planInput.classList.add('ring-4', 'ring-green-300', 'bg-green-50');
                // Auto-scroll to the result
                planResultDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });

                setTimeout(() => { planInput.classList.remove('ring-4', 'ring-green-300', 'bg-green-50'); }, 1500);

            } catch (error) {
                console.error("Full analysis failed:", error);
                alert("Error during analysis: " + error.message);
                planInput.value = `Error: ${error.message}`;
            } finally {
                // 3. End UI feedback
                spinner.classList.add('hidden');
                runButton.disabled = false;
            }
        }

        // --- 1a. Analyze Risk Step (Private Function) ---
        async function analyzeRiskStep(input) {
            const prompt = `Act as a Patient Safety Expert specializing in Root Cause Analysis (RCA).
            Analyze the following healthcare scenario in English: "${input}".
            
            Please provide the output in English using HTML format. Do not use Markdown code blocks.
            Follow this exact structure:
            
            <h3 class="font-bold text-lg text-teal-700 mb-2">1. Event Summary</h3>
            <p class="mb-2 text-slate-600">...Provide a narrative summary of the event...</p>
            <ul class="list-disc pl-5 mb-4 text-slate-600 space-y-1">
                <li>...Key point 1...</li>
                <li>...Key point 2...</li>
            </ul>

            <h3 class="font-bold text-lg text-teal-700 mb-2">2. Event Timeline</h3>
            <ol class="list-decimal pl-5 mb-4 text-slate-600 space-y-1">
                <li>...Detailed step 1...</li>
                <li>...Detailed step 2...</li>
            </ol>

            <h3 class="font-bold text-lg text-amber-700 mb-2">3. Fishbone Diagram Analysis (Ishikawa)</h3>
            <p class="text-xs text-slate-500 mb-3">Structured breakdown of root causes (6Ms)</p>
            <div class="fishbone-grid">
                <div class="fishbone-card"><div class="fishbone-header">üë§ Man (People)</div><ul class="list-disc pl-4 text-xs text-slate-600 space-y-1"><li>...Factor 1...</li><li>...Factor 2...</li></ul></div>
                <div class="fishbone-card"><div class="fishbone-header">‚öôÔ∏è Machine (Equipment)</div><ul class="list-disc pl-4 text-xs text-slate-600 space-y-1"><li>...Factor 1...</li><li>...Factor 2...</li></ul></div>
                <div class="fishbone-card"><div class="fishbone-header">üìù Method (Process)</div><ul class="list-disc pl-4 text-xs text-slate-600 space-y-1"><li>...Factor 1...</li><li>...Factor 2...</li></ul></div>
                <div class="fishbone-card"><div class="fishbone-header">üì¶ Material (Supplies)</div><ul class="list-disc pl-4 text-xs text-slate-600 space-y-1"><li>...Factor 1...</li><li>...Factor 2...</li></ul></div>
                <div class="fishbone-card"><div class="fishbone-header">üå°Ô∏è Environment</div><ul class="list-disc pl-4 text-xs text-slate-600 space-y-1"><li>...Factor 1...</li><li>...Factor 2...</li></ul></div>
                <div class="fishbone-card"><div class="fishbone-header">üìè Measurement</div><ul class="list-disc pl-4 text-xs text-slate-600 space-y-1"><li>...Factor 1...</li><li>...Factor 2...</li></ul></div>
            </div>

            <h3 class="font-bold text-lg text-pink-600 mb-2">4. 5 Whys Analysis</h3>
            <p class="text-xs text-slate-500 mb-3">Drilling down to the deepest root cause</p>
            <div class="bg-pink-50 p-4 rounded-lg border border-pink-100 mb-4">
                 <div class="why-step"><div class="why-number">1</div><div class="why-line"></div><div class="text-sm text-slate-700 pt-1">Why...</div></div>
                 <div class="why-step"><div class="why-number">2</div><div class="why-line"></div><div class="text-sm text-slate-700 pt-1">Why...</div></div>
                 <div class="why-step"><div class="why-number">3</div><div class="why-line"></div><div class="text-sm text-slate-700 pt-1">Why...</div></div>
                 <div class="why-step"><div class="why-number">4</div><div class="why-line"></div><div class="text-sm text-slate-700 pt-1">Why...</div></div>
                 <div class="why-step"><div class="why-number">5</div><div class="text-sm text-slate-700 pt-1 font-bold text-pink-700">Root Cause: ...</div></div>
            </div>
            <h3 class="font-bold text-lg text-green-700 mb-2">5. Christmas Tree Diagram (FTA)</h3>
            <p class="text-xs text-slate-500 mb-3">Top-down analysis of failure pathways</p>
            <div class="bg-green-50 p-4 rounded-lg border border-green-100 mb-4 font-mono text-sm text-slate-700">
                <div><strong>üõë TOP EVENT:</strong> [The main incident]</div>
                <div class="pl-4 border-l-2 border-slate-300 ml-2 mt-2">
                    <div class="bg-slate-200 inline-block px-1 rounded text-xs mb-1">OR Gate</div>
                    <ul class="list-disc pl-5 space-y-1">
                        <li>
                            <strong>Cause A:</strong> ...
                            <div class="pl-4 border-l-2 border-slate-300 mt-1">
                                <span class="bg-slate-200 text-xs px-1 rounded">AND Gate</span>
                                <ul class="list-circle pl-5 mt-1 text-xs">
                                    <li>Basic Event 1</li>
                                    <li>Basic Event 2</li>
                                </ul>
                            </div>
                        </li>
                        <li><strong>Cause B:</strong> ...</li>
                    </ul>
                </div>
            </div>
            <h3 class="font-bold text-lg text-amber-700 mb-2">6. Swiss Cheese Analysis (Layers)</h3>
            <table class="rca-table">
              <thead>
                <tr>
                    <th width="30%">System Layer</th>
                    <th width="20%">Type</th>
                    <th>Description</th>
                </tr>
              </thead>
              <tbody>
                <tr><td><strong>Organizational Influences</strong></td><td>Latent</td><td>...</td></tr>
                <tr><td><strong>Unsafe Supervision</strong></td><td>Latent</td><td>...</td></tr>
                <tr><td><strong>Preconditions</strong></td><td>Latent</td><td>...</td></tr>
                <tr><td><strong>Unsafe Acts</strong></td><td>Active</td><td>...</td></tr>
              </tbody>
            </table>`;

            const responseText = await callGemini(prompt);
            let formattedText = responseText.replace(/```html/g, '').replace(/```/g, '');
            const cleanText = responseText.replace(/<[^>]*>?/gm, ''); 
            
            if (formattedText.includes("Error") || formattedText.length < 50) {
                 throw new Error("Risk analysis failed");
            }

            return { html: formattedText, cleanText: cleanText };
        }

        // --- 1b. Action Plan Generation Step (Private Function) ---
        async function generateActionPlanStep(analysisData) {
            const prompt = `Act as a Hospital Safety Manager. 
            Based on the analysis data: "${analysisData}".

            Create a comprehensive response in English HTML containing 3 distinct tables followed by a conclusion section.
            
            Part 1: PDSA Strategy Summary (Format: Blue Header, Expanded PDSA Detail)
            <h3 class="font-bold text-lg text-blue-700 mb-2">1. PDSA Strategy Summary</h3>
            <table class="action-table" style="width:100%; border-collapse: collapse; border: 1px solid #ddd;">
              <tr style="background-color:#0EA5E9; color: white;">
                 <th style="padding:10px;">Topic</th><th style="padding:10px;">Details</th>
              </tr>
              <tr><td><strong>Objective</strong></td><td>...</td></tr>
              <tr>
                <td><strong>PDSA Cycle</strong></td>
                <td>
                  <ul style="list-style-type: disc; margin-left: 20px; padding-left: 0;">
                    <li><strong>Plan:</strong> ...detailed planning activities...</li>
                    <li><strong>Do:</strong> ...key implementation actions...</li>
                    <li><strong>Study:</strong> ...critical metrics...</li>
                    <li><strong>Act:</strong> ...next cycle planning...</li>
                  </ul>
                </td>
              </tr>
              <tr><td><strong>Key KPIs</strong></td><td>...</td></tr>
            </table>

            Part 2: Detailed Action Plan (Format: Teal Header)
            <h3 class="font-bold text-lg text-teal-700 mt-6 mb-2">2. Detailed Action Plan</h3>
            <table class="action-table" style="width:100%; border-collapse: collapse; border: 1px solid #ddd;">
              <tr style="background-color:#0D9488; color: white;">
                 <th style="padding:10px;">Objective</th>
                 <th style="padding:10px;">Steps</th>
                 <th style="padding:10px;">KPIs</th>
                 <th style="padding:10px;">Target</th>
                 <th style="padding:10px;">Resources</th>
                 <th style="padding:10px;">Owner</th>
                 <th style="padding:10px;">Timeline</th>
              </tr>
              <tr><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td></tr>
            </table>

            Part 3: Initiatives for Patient Safety (Format: Violet Header)
            <h3 class="font-bold text-lg text-purple-700 mt-6 mb-2">3. Innovative Safety Initiatives</h3>
            <table class="initiative-table" style="width:100%; border-collapse: collapse; border: 1px solid #ddd;">
              <tr style="background-color:#7C3AED; color: white;">
                 <th style="padding:10px;">No.</th>
                 <th style="padding:10px;">Initiative</th>
                 <th style="padding:10px;">Brief Description</th>
                 <th style="padding:10px;">How-to</th>
                 <th style="padding:10px;">Key Responsible</th>
                 <th style="padding:10px;">Expected Outcome</th>
              </tr>
              <tr><td>1</td><td>...</td><td>...</td><td>...</td><td>...</td><td>...</td></tr>
            </table>
            
            <h3 class="font-bold text-lg text-indigo-700 mt-6 mb-2">4. Conclusion & Recommendations</h3>
            <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-200 text-sm space-y-3">
                <p><strong>Key Actions Summary:</strong> ...</p>
                <p><strong>Lessons Learned:</strong> ...</p>
                <p><strong>Safety Culture Vision:</strong> ...</p>
            </div>`;

            try {
                const responseText = await callGemini(prompt);
                let formattedContent = responseText.replace(/```html/g, '').replace(/```/g, '');

                if (formattedContent.length < 50) {
                     console.warn("Response too short:", formattedContent);
                     throw new Error("AI returned an incomplete response.");
                }
                return formattedContent;

            } catch (error) {
                console.error("Action Plan Error:", error);
                throw new Error(`Action Plan Generation Failed: ${error.message}`);
            }
        }

        // --- Feature 3: Export to Word ---
        function exportToWord() {
            const scenario = document.getElementById('scenarioInput').value;
            const riskAnalysis = document.getElementById('analyzeResult').innerHTML;
            const actionPlan = document.getElementById('planResult').innerHTML;

            if (!actionPlan || actionPlan.includes("loader") || document.getElementById('planInput').value.includes("Waiting")) { alert("Please complete the analysis and action plan generation first."); return; }

            const content = `
                <html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
                <head>
                    <meta charset='utf-8'>
                    <title>Safety Action Plan</title>
                    <style>
                        body { font-family: 'Arial', 'Calibri', sans-serif; font-size: 11pt; line-height: 1.2; color: #333; }
                        h1 { color: #1e3a8a; text-align: center; font-size: 16pt; margin-bottom: 5px; font-weight: bold; }
                        h2 { color: #0f766e; border-bottom: 2px solid #0f766e; padding-bottom: 5px; margin-top: 25px; font-size: 14pt; font-weight: bold; }
                        h3 { color: #444; font-size: 12pt; margin-top: 20px; margin-bottom: 10px; font-weight: bold; }
                        table { border-collapse: collapse; width: 100%; margin-bottom: 20px; font-size: 10pt; }
                        th, td { border: 1px solid #000; padding: 5px 10px; vertical-align: top; text-align: left; }
                        th { color: white; font-weight: bold; }
                        .rca-table th { background-color: #F59E0B; }
                        .action-table th { background-color: #0EA5E9; } 
                        .initiative-table th { background-color: #7C3AED; }
                        table:nth-of-type(1) th { background-color: #1e293b; }
                        .fishbone-grid { display: table; width: 100%; }
                        .fishbone-card { display: table-cell; border: 1px solid #ccc; padding: 10px; width: 30%; margin: 5px; }
                        ul, ol { margin: 0; padding-left: 25px; }
                        li { margin-bottom: 3px; }
                    </style>
                </head>
                <body>
                    <div style="text-align: right; font-size: 10pt; color: #666; margin-bottom: 20px;">Date: ${new Date().toLocaleDateString('en-US')}</div>
                    <h1>Safety Action Plan Report</h1>
                    <h2>1. Risk Analysis</h2>
                    <table><tr><th style="background-color:#1e293b;" width="20%">Scenario</th><td>${scenario || '-'}</td></tr></table>
                    ${riskAnalysis || '-'}
                    <h2>2. Action Plan & Initiatives</h2>
                    ${actionPlan}
                    <br><p style="text-align: center; font-size: 9pt; color: #999; margin-top:50px;">Document generated by RCA Insight Companion</p>
                </body>
                </html>
            `;
            const blob = new Blob(['\ufeff', content], { type: 'application/msword' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `Safety_Plan_Initiatives_${new Date().toISOString().slice(0,10)}.doc`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Charts (Standard)
        Chart.defaults.font.family = "'Sarabun', sans-serif";
        Chart.defaults.color = '#64748B';
        const ctx = document.getElementById('assessmentChart');
        const assessmentChart = new Chart(ctx, {
            type: 'bar',
            data: { 
                labels: ['Teamwork', 'Staffing & Work Pace', 'Org. Learning', 'Response to Error', 'Supervisor Support', 'Comm. About Error', 'Comm. Openness', 'Reporting Events', 'Hospital Mgmt. Support', 'Handoffs & Info'], 
                datasets: [
                    { label: 'Your Hospital (% Positive)', data: [0,0,0,0,0,0,0,0,0,0], backgroundColor: '#0D9488', borderRadius: 4, barPercentage: 0.6 }, 
                    { label: 'Ideal Goal (100%)', data: [100,100,100,100,100,100,100,100,100,100], backgroundColor: '#E2E8F0', borderRadius: 4, barPercentage: 0.6, borderWidth: 1, borderColor: '#94A3B8' }
                ] 
            },
            options: { 
                indexAxis: 'y', responsive: true, maintainAspectRatio: false, 
                scales: { x: { suggestedMin: 0, max: 100, grid: { color: '#f1f5f9' }, title: { display: true, text: '% Positive Response' } }, y: { grid: { display: false } } }, 
                plugins: { tooltip: { callbacks: { title: ctx => Array.isArray(ctx[0].label) ? ctx[0].label.join(' ') : ctx[0].label, label: function(context) { return context.dataset.label + ': ' + context.parsed.x + '%'; } }, padding: 12, backgroundColor: '#1E293B' }, legend: { position: 'bottom' } } 
            }
        });

        function updateChartData(index, value) {
            document.getElementById(`val-${index}`).innerText = parseFloat(value).toFixed(2) + '%';
            assessmentChart.data.datasets[0].data[index] = value;
            assessmentChart.update();
        }
    </script>
</body>
</html>
